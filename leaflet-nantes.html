<!DOCTYPE html>
<html>
<head>
	<title>Leaflet Quick Start Guide Example</title>
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
<style>
    #map {
      width: 960px;
      height: 500px;
    }

    .active {
        stroke: green;
        stroke-width: 1px;
    }
</style>

</head>
<body>
    <div id="mylist"></div>
	<div id="map"></div>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
    <script src="leaflet.ajax.js"></script>

	<script>
		var initialBounds = new L.latLngBounds(new L.latLng(47.18, -1.64), new L.latLng(47.295, -1.47));
            map = L.map('map', {
                center: [47.2375, -1.555],
                zoom: 12,
                maxZoom: 16,
                minZoom: 11,
                //maxBounds: initialBounds
            });

d3.csv("data/geo/centroides-bureaux-votes.csv", function(error, data) {
//    console.log(data);
function change() {
    //
    var object = this.options[this.selectedIndex].__data__;
    map.panTo(new L.latLng(object.Y, object.X)).setZoom(16);
}

d3.select("#mylist").append("select")
    .on("change", change)
.selectAll("option").data(data).enter().append("option")
    .attr("value", function(d){ return d.IDBURO; }) /* Optional */
    .text(function(d){ return d.IDBURO; })

});



	

		L.tileLayer('http://{s}.acetate.geoiq.com/tiles/' + 'terrain' + '/{z}/{x}/{y}' + '.png', {
			//maxZoom: 18,
            opacity: 0.4,
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://cloudmade.com">CloudMade</a>'
		}).addTo(map);


		L.tileLayer('http://{s}.acetate.geoiq.com/tiles/' + 'acetate-labels' + '/{z}/{x}/{y}' + '.png', {
			//maxZoom: 18,
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://cloudmade.com">CloudMade</a>'
		}).addTo(map);





var generateSvgWithGroup = function(customClass) {
    var el = L.DomUtil.create('div', customClass +' leaflet-zoom-hide');
    map.getPanes().overlayPane.appendChild(el);
    var svgEl = d3.select('.' + customClass).append("svg");
    var group = svgEl.append("g").attr("class", "leaflet-zoom-hide");
    return {
        group: group,
        svg: svgEl    
    }
}


var mySecondLayer = generateSvgWithGroup('my-custom-layer');

var svg = d3.select(map.getPanes().overlayPane).append("svg"),
    g = svg.append("g").attr("class", "leaflet-zoom-hide");


//d3.json("data/geo/bureaux-votes-nantes.geojson", function(collection) {
/*
d3.json("data/geo/bureaux-votes-nantes-points.geojson", function(collection) {
  var transform = d3.geo.transform({point: projectPoint}),
      path = d3.geo.path().projection(transform),
      bounds = path.bounds(collection);

  var feature = g.selectAll("path")
      .data(collection.features)
    .enter().append("path");

  map.on("viewreset", reset);
  reset();

  // Reposition the SVG to cover the features.
  function reset() {
    bounds = path.bounds(collection);
    var topLeft = bounds[0],
        bottomRight = bounds[1];

    svg .attr("width", bottomRight[0] - topLeft[0])
        .attr("height", bottomRight[1] - topLeft[1])
        .style("left", topLeft[0] + "px")
        .style("top", topLeft[1] + "px");

    g .attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");

    feature.attr("d", path)
    .on('mouseover', function(d) {
        console.log(d.properties['2444004040']);
    });
  }

  // Use Leaflet to implement a D3 geometric transformation.
  function projectPoint(x, y) {
    var point = map.latLngToLayerPoint(new L.LatLng(y, x));
    this.stream.point(point.x, point.y);
  }
});
*/

d3.json("data/geo/bureaux-votes-nantes.geojson", function(collection) {
  var transform1 = d3.geo.transform({point: projectPoint1}),
      path1 = d3.geo.path().projection(transform1),
      bounds1 = path1.bounds(collection);

  var feature1 = mySecondLayer.group.selectAll("path")
      .data(collection.features)
    .enter().append("path");

  map.on("viewreset", reset);
  reset(mySecondLayer.svgEl);

  // Reposition the SVG to cover the features.
  function reset(svg) {
    bounds1 = path1.bounds(collection);
    var topLeft = bounds1[0],
        bottomRight = bounds1[1];

    mySecondLayer.svg.attr("width", bottomRight[0] - topLeft[0])
        .attr("height", bottomRight[1] - topLeft[1])
        .style("left", topLeft[0] + "px")
        .style("top", topLeft[1] + "px")
//        .attr("fill", "red");
        .attr("stroke-width", 0.4)
        .attr("stroke", "black")
        //.attr("stroke-opacity", 1);
        .attr("fill-opacity", 0);


    mySecondLayer.group.attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");


    feature1.attr("d", path1)
    /*.on('mouseover', function(d) {
        console.log(d.properties);
    });*/
    .on('click', countyClickHandler);

  /*
   * Fonction qui permet de zoomer sur la carte
   * en cliquant sur les départements
   * Récupéré ici : http://bl.ocks.org/mbostock/2206340
   */
  var centered;
  function countyClickHandler(d) {
    var x, y, k;
 
    if (d && centered !== d) {
            //var centroid = path.centroid(d);
            //x = centroid[0];
            //y = centroid[1];
            //k = 5;
            centered = d;
        } else {
            //x = width / 2;
            //y = height / 2;
            //k = 1;
            centered = null;
        }
        console.log(mySecondLayer.group.selectAll("path"));
        mySecondLayer.group.selectAll("path")
            .classed("active", centered && function(d) { return d === centered; });
        
        //document.getElementById('contenu').innerHTML = d.properties.IDBURO + " " + d.properties.LIEU_NOM + " " + d.properties.LIEU_SITE + " " + d.properties.LIEU_ADRES;

        /*
        var trStr = "translate(" + width / 2 + "," + height / 2 + ")" +
            "scale(" + k + ")translate(" + -x + "," + -y + ")";
         
        deps.transition()
            .duration(1000)
            .attr("transform", trStr);
        */
    };

  }

  // Use Leaflet to implement a D3 geometric transformation.
  function projectPoint1(x, y) {
    var point1 = map.latLngToLayerPoint(new L.LatLng(y, x));
    this.stream.point(point1.x, point1.y);
  }
});

	</script>
</body>
</html>

